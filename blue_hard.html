<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Game</title>
    
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-image: url('introbg2.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            font-family: Arial, sans-serif;
            margin: 0;
        }

        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('introbg2.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #start-button {
            cursor: pointer;
            transition: transform 0.2s ease;
            animation: blink 1.5s infinite;
        }

        #start-button:hover {
            transform: scale(1.1);
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }

        header {
            padding: 10px;
            margin-top: 150px;
            text-align: center;
            color: #FF66d8;
            display: none;
        }

        header img {
            width: 200px;
            height: auto;
        }

        .judgment-display {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #ffffff62;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: -0;
            display: none;
        }

        .judgment-effect {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            opacity: 1;
            transition: all 0.5s ease-out;
            z-index: 9999;
            pointer-events: none;
        }

        .judgment-effect.perfect {
            color: #ff3d9e;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .judgment-effect.good {
            color: #00ffaa;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .judgment-effect.miss {
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .judgment-effect.fade-out {
            opacity: 0;
            transform: translate(-50%, -60%) scale(1.2);
        }
        
        #game-container {
            display: none;
            justify-content: center;
            align-items: flex-start;
            flex-direction: row;
            width: 100%;
            height: 875px;
            background-color: #0f1018;
            position: relative;
            perspective: 1000px;
            background-image: url('pinkb1.jpg');
            background-size: 100% auto;
            background-position: center;
        }

        .lane {
            display: flex;
            justify-content: center;
            width: 180px;
            height: 800px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.85);
            margin: 0;
            transition: background-color 0.3s ease;
            overflow: hidden;
        }

        .key-label {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffffff50;
            font-size: 48px;
            font-weight: bold;
            z-index: 2;
            pointer-events: none;
        }

        footer {
            color: white;
            text-align: center;
            margin-top: 100px;
        }

        .note {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 10px !important;
            background-color: #85ffda;
            opacity: 0.9;
            z-index: 2;
            box-shadow: 0 0 10px rgba(133, 255, 218, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .note img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 2px;
        }

        .long-note {
            background-color: #ff85c2;
            height: 100px !important;
        }

        .long-note::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background-color: #ff85c2;
            box-shadow: 0 0 10px rgba(255, 133, 194, 0.5);
        }

        .long-note::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background-color: #ff85c2;
            border-radius: 0 0 2px 2px;
            box-shadow: 0 0 10px rgba(255, 133, 194, 0.5);
        }

        .note.holding {
            background-color: #ff3399;
            opacity: 0.8;
            box-shadow: 0 0 15px rgba(255, 51, 153, 0.7);
        }

        #score {
            position: absolute;
            margin-left: 600px;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 100px;
            font-weight: bold;
            z-index: 1000;
            background: linear-gradient(to top, rgb(255, 131, 224), rgb(255, 255, 255)80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes hitEffect {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        .hit-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
        }

        .hit-effect.perfect {
            border: 3px solid #ffa7d3;
            box-shadow: 0 0 10px #ffa7d3;
            animation: hitEffect 0.4s ease-out forwards;
        }

        .hit-effect.good {
            border: 3px solid #a5ffe8;
            box-shadow: 0 0 10px #a5ffe8;
            animation: hitEffect 0.4s ease-out forwards;
        }

        .judgment-line {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #caffea;
            box-shadow: 0 0 5px #bff8e0;
        }

        .hit {
            background-color: #bff8e0 !important;
            animation: hitEffect 1s ease-out, glow 0.6s ease-out;
        }

        .result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .result-content {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        .result-content h1 {
            color: #ff66d8;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 0 0 20px rgba(255, 102, 216, 0.5);
        }

        .result-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-radius: 12px;
            background: rgba(255, 102, 216, 0.1);
            transition: background-color 0.3s ease;
        }

        .stat-item:nth-child(odd) {
            background: rgba(255, 102, 216, 0.15);
        }

        .stat-item:hover {
            background: rgba(255, 102, 216, 0.2);
        }

        .stat-label {
            color: #ff99e6;
            font-size: 1.1em;
            font-weight: 500;
        }

        .stat-value {
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }

        .result-breakdown {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 102, 216, 0.08);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .breakdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .breakdown-label {
            color: #ff99e6;
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .breakdown-count {
            color: white;
            font-weight: bold;
            font-size: 1.5em;
        }

        .result-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(145deg, #ff66d8, #ff99e6);
            color: #1a1a2e;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 0.95em;
            flex: 1;
            box-shadow: 0 4px 15px rgba(255, 102, 216, 0.3);
        }

        .btn:hover {
            background: linear-gradient(145deg, #ff99e6, #ffccf2);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 102, 216, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 102, 216, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(145deg, #4a4a6a, #6a6a8a);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 74, 106, 0.3);
        }

        .btn.secondary:hover {
            background: linear-gradient(145deg, #6a6a8a, #8a8aaa);
            box-shadow: 0 6px 20px rgba(74, 74, 106, 0.4);
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="start-screen">
        <img id="start-button" src="start.png" alt="Start Game" style="width: 300px; height: auto;">
    </div>

    <header id="header">
        <img src="logo.png" alt="Rhythm Rush Logo">
    </header>

    <div class="judgment-display" id="judgment"></div>
    <div class="combo-display" id="combo">0</div>
    <audio id="game-audio" src="bluemusic.mp3" preload="auto"></audio>
    
    <div id="game-container">
        <div class="lane" id="lane-d">
            <div class="key-label">D</div>
            <div class="judgment-line"></div>
        </div>
        <div class="lane" id="lane-f">
            <div class="key-label">F</div>
            <div class="judgment-line"></div>
        </div>
        <div class="lane" id="lane-j">
            <div class="key-label">J</div>
            <div class="judgment-line"></div>
        </div>
        <div class="lane" id="lane-k">
            <div class="key-label">K</div>
            <div class="judgment-line"></div>
        </div>
        <div id="score">0</div>
    </div>

    <footer id="contact">
        <p>© 2025 디콘디 임예지</p>
    </footer>

    <script>
        // 난이도별 패턴 정의 - Normal 난이도로 기본 설정 (이미지 추가)
        const patterns = {
            normal: [
                { time: 800, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 1000, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 1200, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 1400, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 1600, lane: 'j', speed: 3, image: 'note1.png' },
                { time: 1800, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 2000, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 2200, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 2400, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 2600, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 2800, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 3000, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 3200, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 3500, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 3500, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 3700, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 4000, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 4300, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 4600, lane: 'j', speed: 3, image: 'note1.png' },
                { time: 4900, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 5200, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 5500, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 5800, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 6100, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 6300, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 6600, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 6900, lane: 'k', speed: 3, image: 'note3.png' },
                { time: 7200, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 7500, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 7800, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 8100, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 8400, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 8700, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 9000, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 9300, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 9600, lane: 'k', speed: 3, image: 'note3.png' },
                { time: 9900, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 10200, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 10500, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 10800, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 11000, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 11300, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 11600, lane: 'j', speed: 3, image: 'note1.png' },
                { time: 11900, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 12200, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 12500, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 12800, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 13100, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 13400, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 13700, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 14100, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 14400, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 14700, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 15000, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 15300, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 15600, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 15900, lane: 'k', speed: 3, image: 'note3.png' },
                { time: 16200, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 16500, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 16800, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 17100, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 17400, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 17700, lane: 'k', speed: 3, image: 'note3.png' },
                { time: 18000, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 18300, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 18600, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 18900, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 19200, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 19500, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 19800, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 20100, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 20400, lane: 'k', speed: 3, image: 'note3.png' },
                { time: 20700, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 21000, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 21300, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 21600, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 21900, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 22200, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 22500, lane: 'j', speed: 3, image: 'note1.png' },
                { time: 22800, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 23100, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 23400, lane: 'f', speed: 3, image: 'note1.png'},
                { time: 23700, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 24000, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 24300, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 24600, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 24900, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 25200, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 25500, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 25800, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 26100, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 26400, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 26700, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 27000, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 27300, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 27600, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 27900, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 28200, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 28500, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 28800, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 29100, lane: 'k', speed: 3, image: 'note3.png' },
                { time: 29400, lane: 'd', speed: 3, image: 'note1.png' },
                { time: 29700, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 30000, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 30300, lane: 'f', speed: 3, image: 'note1.png' },
                { time: 30600, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 30900, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 31200, lane: 'j', speed: 3, image: 'note1.png' },
                { time: 31500, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 31800, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 32100, lane: 'f', speed: 3, image: 'note1.png'},
                { time: 32400, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 32700, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 33000, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 33300, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 33600, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 33900, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 34200, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 34500, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 34800, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 35100, lane: 'j', speed: 3, image: 'note1.png' },
                { time: 35400, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 35700, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 36000, lane: 'f', speed: 3, image: 'note1.png'},
                { time: 36300, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 36600, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 36900, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 37200, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 37500, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 37800, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 38100, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 38400, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 38700, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 39000, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 39300, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 39600, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 39900, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 40200, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 40500, lane: 'f', speed: 3, image: 'note3.png' },
                { time: 40800, lane: 'j', speed: 3, image: 'note1.png' },
                { time: 41100, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 41400, lane: 'd', speed: 3, image: 'note3.png' },
                { time: 41700, lane: 'f', speed: 3, image: 'note1.png'},
                { time: 42000, lane: 'f', speed: 3, image: 'note2.png' },
                { time: 42300, lane: 'j', speed: 3, image: 'note3.png' },
                { time: 42600, lane: 'k', speed: 3, image: 'note1.png' },
                { time: 42900, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 43200, lane: 'd', speed: 3, image: 'note2.png' },
                { time: 43500, lane: 'k', speed: 3, image: 'note2.png' },
                { time: 43800, lane: 'j', speed: 3, image: 'note2.png' },
                { time: 44100, lane: 'k', speed: 3, image: 'note2.png' }
            ]
        };

        // 게임 요소 초기화
        const gameAudio = document.getElementById('game-audio');
        const scoreDisplay = document.getElementById('score');
        const judgmentDisplay = document.getElementById('judgment');
        const comboDisplay = document.getElementById('combo');
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let judgmentCounts = {
            'Perfect': 0,
            'Good': 0,
            'Miss': 0
        };

        let activeNotes = new Map();
        let pressedKeys = new Set();
        let gameActive = false;
        let noteTimeouts = [];

        // 키 매핑
        const keyMap = {
            'd': 'lane-d',
            'f': 'lane-f',
            'j': 'lane-j',
            'k': 'lane-k'
        };

        const lanes = {};
        Object.keys(keyMap).forEach(key => {
            lanes[key] = document.getElementById(keyMap[key]);
        });

        // 판정 이펙트 생성 함수 (화면 정중앙에 표시)
        function createJudgmentEffect(judgment) {
            // 기존 판정 이펙트 제거
            const existingEffects = document.querySelectorAll('.judgment-effect');
            existingEffects.forEach(effect => effect.remove());

            // 새 판정 이펙트 생성
            const judgmentEffect = document.createElement('div');
            judgmentEffect.classList.add('judgment-effect', judgment.toLowerCase());
            judgmentEffect.textContent = judgment;

            // body에 직접 추가하여 화면 전체에서 중앙 위치 보장
            document.body.appendChild(judgmentEffect);

            // 페이드 아웃 애니메이션
            setTimeout(() => {
                judgmentEffect.classList.add('fade-out');
            }, 300);

            // 요소 제거
            setTimeout(() => {
                if (judgmentEffect.parentNode) {
                    judgmentEffect.parentNode.removeChild(judgmentEffect);
                }
            }, 800);
        }

        // 노트 생성 함수 (이미지 지원 추가)
        function createNote(laneKey, noteData) {
            if (!gameActive) return;
            
            const lane = lanes[laneKey];
            if (!lane) return;

            const note = document.createElement('div');
            note.classList.add('note');

            // 이미지가 있는 경우 이미지 추가
            if (noteData.image) {
                const img = document.createElement('img');
                img.src = noteData.image;
                img.alt = 'Note';
                img.onerror = function() {
                    // 이미지 로드 실패 시 기본 스타일 유지
                    this.style.display = 'none';
                };
                note.appendChild(img);
            }

            if (noteData.type === 'long') {
                note.classList.add('long-note');
                note.style.height = `${noteData.duration / 10}px`;
            } else if (noteData.type === 'multi') {
                note.classList.add('multi-note');
            }

            note.style.top = '0px';
            lane.appendChild(note);

            let currentPosition = 0;
            const maxDistance = 775;
            const speed = noteData.speed || 1;

            const fallInterval = setInterval(() => {
                if (!gameActive) {
                    clearInterval(fallInterval);
                    if (note.parentNode) {
                        note.parentNode.removeChild(note);
                    }
                    return;
                }
                
                if (currentPosition >= maxDistance) {
                    clearInterval(fallInterval);
                    if (note.parentNode) {
                        note.parentNode.removeChild(note);
                        updateJudgment('Miss', lane);
                    }
                    return;
                }
                currentPosition += 5 * speed;
                note.style.top = `${currentPosition}px`;
            }, 20);

            return note;
        }

        // 판정 함수
        function getJudgment(notePosition) {
            const judgmentLinePosition = 735;
            const diff = Math.abs(notePosition - judgmentLinePosition);

            if (diff <= 40) return 'Perfect';
            if (diff <= 80) return 'Good';
            return 'Miss';
        }

        // 히트 이펙트 생성 함수
        function createHitEffect(lane, judgment) {
            const judgmentLine = lane.querySelector('.judgment-line');
            const rect = judgmentLine.getBoundingClientRect();
            
            const effect = document.createElement('div');
            effect.className = `hit-effect ${judgment.toLowerCase()}`;
            
            effect.style.left = `${rect.left + rect.width / 2}px`;
            effect.style.top = `${rect.top}px`;
            
            document.body.appendChild(effect);
            
            effect.addEventListener('animationend', () => {
                effect.remove();
            });
        }

        // 판정 업데이트 함수
        function updateJudgment(judgment, lane) {
            judgmentDisplay.textContent = judgment;
            judgmentDisplay.className = 'judgment-display ' + judgment.toLowerCase();
            
            // 화면 중앙에 판정 텍스트 표시
            createJudgmentEffect(judgment);
            
            judgmentCounts[judgment]++;

            if (judgment === 'Perfect' || judgment === 'Good') {
                createHitEffect(lane, judgment);
            }

            if (judgment === 'Perfect') {
                score += 100 * (combo + 1);
                combo++;
            } else if (judgment === 'Good') {
                score += 50 * (combo + 1);
                combo++;
            } else if (judgment === 'Miss') {
                combo = 0;
            }

            maxCombo = Math.max(maxCombo, combo);

            scoreDisplay.textContent = score;
            comboDisplay.textContent = `${combo}`;

            setTimeout(() => {
                judgmentDisplay.textContent = '';
            }, 500);
        }

        // 개선된 키 입력 처리
        function handleKeyDown(e) {
            if (!gameActive) return;
            
            // 키 코드와 키 이름 둘 다 확인
            const key = e.key ? e.key.toLowerCase() : String.fromCharCode(e.keyCode || e.which).toLowerCase();
            const keyCode = e.keyCode || e.which;
            
            // 키 매핑 개선 (키코드도 함께 확인)
            let mappedKey = null;
            
            if (key === 'd' || keyCode === 68) mappedKey = 'd';
            else if (key === 'f' || keyCode === 70) mappedKey = 'f';
            else if (key === 'j' || keyCode === 74) mappedKey = 'j';
            else if (key === 'k' || keyCode === 75) mappedKey = 'k';
            
            if (!mappedKey || pressedKeys.has(mappedKey)) return;

            // 기본 키 이벤트 방지 (맥에서 특수 키 조합 방지)
            e.preventDefault();
            
            pressedKeys.add(mappedKey);
            const lane = lanes[mappedKey];
            if (!lane) return;
            
            changeLaneColor(lane, true);
            
            const notes = lane.getElementsByClassName('note');
            if (notes.length === 0) return;

            const firstNote = notes[0];
            const notePosition = parseInt(firstNote.style.top || '0');
            const judgment = getJudgment(notePosition);

            if (judgment === 'Miss') return;

            firstNote.remove();
            updateJudgment(judgment, lane);
        }

        function handleKeyUp(e) {
            if (!gameActive) return;
            
            const key = e.key ? e.key.toLowerCase() : String.fromCharCode(e.keyCode || e.which).toLowerCase();
            const keyCode = e.keyCode || e.which;
            
            let mappedKey = null;
            
            if (key === 'd' || keyCode === 68) mappedKey = 'd';
            else if (key === 'f' || keyCode === 70) mappedKey = 'f';
            else if (key === 'j' || keyCode === 74) mappedKey = 'j';
            else if (key === 'k' || keyCode === 75) mappedKey = 'k';
            
            if (!mappedKey) return;

            e.preventDefault();
            
            pressedKeys.delete(mappedKey);
            const lane = lanes[mappedKey];
            if (lane) {
                changeLaneColor(lane, false);
            }
        }

        // 레인 색상 변경
        function changeLaneColor(lane, isKeyDown) {
            lane.style.backgroundColor = isKeyDown ? 'rgba(255, 102, 216, 0.3)' : '#000000d5';
        }

        // 홈 화면으로 이동 함수
        function goToHome() {
            // 외부 URL로 이동
            window.location.href = 'https://yejiimda.github.io/Colorhythm/yellow_game.html';
        }

        // 캐릭터 선택 화면으로 이동 함수
        function goToCharacterSelect() {
            alert('캐릭터 선택 기능은 향후 추가될 예정입니다!');
            // 실제 구현 시에는 캐릭터 선택 화면을 표시하는 로직 추가
        }

        // 게임 상태 초기화 함수
        function resetGameState() {
            gameActive = false;
            clearAllTimeouts();
            
            score = 0;
            combo = 0;
            maxCombo = 0;
            judgmentCounts = {
                'Perfect': 0,
                'Good': 0,
                'Miss': 0
            };

            scoreDisplay.textContent = '0';
            comboDisplay.textContent = '0';

            // 기존 노트 제거
            Object.values(lanes).forEach(lane => {
                const notes = lane.getElementsByClassName('note');
                while (notes.length > 0) {
                    notes[0].remove();
                }
            });

            // 기존 판정 이펙트 제거
            const existingEffects = document.querySelectorAll('.judgment-effect');
            existingEffects.forEach(effect => effect.remove());
        }

        // 결과창 생성 함수
        function showResultScreen() {
            const resultScreen = document.createElement('div');
            resultScreen.id = 'result-screen';
            resultScreen.classList.add('result-screen');

            const totalNotes = judgmentCounts.Perfect + judgmentCounts.Good + judgmentCounts.Miss;
            const accuracy = totalNotes > 0 
                ? ((judgmentCounts.Perfect + judgmentCounts.Good * 0.5) / totalNotes * 100).toFixed(2) 
                : 0;

            resultScreen.innerHTML = `
                <div class="result-content">
                    <h1>Game Results</h1>
                    <div class="result-stats">
                        <div class="stat-item">
                            <span class="stat-label">점수</span>
                            <span class="stat-value">${score.toLocaleString()}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">최대 콤보</span>
                            <span class="stat-value">${maxCombo}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">정확도</span>
                            <span class="stat-value">${accuracy}%</span>
                        </div>
                    </div>
                    <div class="result-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-label">Perfect</span>
                            <span class="breakdown-count">${judgmentCounts.Perfect}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Good</span>
                            <span class="breakdown-count">${judgmentCounts.Good}</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Miss</span>
                            <span class="breakdown-count">${judgmentCounts.Miss}</span>
                        </div>
                    </div>
                    <div class="result-actions">
                        <button id="restart-btn" class="btn">다시하기</button>
                        <button id="home-btn" class="btn secondary">홈으로</button>
                        <button id="character-select-btn" class="btn secondary">캐릭터 선택</button>
                    </div>
                </div>
            `;

            document.body.appendChild(resultScreen);

            // 버튼 이벤트 리스너 등록
            document.getElementById('restart-btn').addEventListener('click', restartGame);
            document.getElementById('home-btn').addEventListener('click', goToHome);
            document.getElementById('character-select-btn').addEventListener('click', goToCharacterSelect);
        }

        // 게임 재시작 함수
        function restartGame() {
            const resultScreen = document.getElementById('result-screen');
            if (resultScreen) resultScreen.remove();

            // 상태 초기화
            resetGameState();

            // 게임 시작
            startGame();
        }

        // 오디오 종료 시 게임 종료를 처리하는 함수
        function setupGameEndHandler() {
            gameAudio.addEventListener('ended', function() {
                gameActive = false;
                clearAllTimeouts();
                showResultScreen();
            });
        }

        // 모든 타임아웃 클리어 함수
        function clearAllTimeouts() {
            noteTimeouts.forEach(timeoutId => {
                clearTimeout(timeoutId);
            });
            noteTimeouts = [];
        }

        // 오디오 초기화 함수 추가
        function initializeAudio() {
            try {
                // Safari에서 오디오 컨텍스트 활성화
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('Audio context resumed');
                    });
                }
                
                // 오디오 preload 설정
                gameAudio.load();
                gameAudio.volume = 0.8;
                
                console.log('Audio initialized successfully');
            } catch (error) {
                console.log('Audio initialization failed:', error);
            }
        }

        // 게임 시작 함수 (Safari 호환 오디오 재생)
        function startGame() {
            gameActive = true;
            clearAllTimeouts();
            
            // 시작 화면 숨기고 게임 화면 표시
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            document.getElementById('header').style.display = 'block';
            document.getElementById('combo').style.display = 'block';

            const currentPattern = patterns.normal;

            // 점수, 콤보, 판정 통계 초기화
            score = 0;
            combo = 0;
            maxCombo = 0;
            judgmentCounts = {
                'Perfect': 0,
                'Good': 0,
                'Miss': 0
            };

            scoreDisplay.textContent = '0';
            comboDisplay.textContent = '0';

            // Safari 호환 오디오 재생
            gameAudio.currentTime = 0;
            
            // Promise 기반 재생으로 에러 처리
            const playPromise = gameAudio.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('Audio started successfully');
                        setupGameEndHandler();
                    })
                    .catch(error => {
                        console.log('Audio play failed:', error);
                        // 오디오 없이 게임 진행
                        alert('오디오 재생에 실패했습니다. 음악 없이 게임을 진행합니다.');
                        setupGameEndHandler();
                    });
            } else {
                setupGameEndHandler();
            }

            // 노트 생성
            currentPattern.forEach(noteData => {
                const timeoutId = setTimeout(() => {
                    if (!gameActive) return;
                    
                    if (Array.isArray(noteData.lane)) {
                        noteData.lane.forEach(lane => {
                            createNote(lane, { ...noteData, type: 'multi' });
                        });
                    } else {
                        createNote(noteData.lane, noteData);
                    }
                }, noteData.time);
                noteTimeouts.push(timeoutId);
            });
        }

        // 키보드 테스트 함수 추가 (디버깅용)
        function testKeyboard() {
            document.addEventListener('keydown', function(e) {
                console.log('Key pressed:', e.key, 'KeyCode:', e.keyCode);
            });
        }

        // 이벤트 리스너 등록
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);

        // 시작 버튼 클릭 이벤트
        document.getElementById('start-button').addEventListener('click', function() {
            console.log('Start button clicked');
            
            // 오디오 파일 존재 확인 (디버깅용)
            console.log('Audio element:', gameAudio);
            console.log('Audio src:', gameAudio.src);
            
            startGame();
        });

        // 페이지 로드 시 초기화
        window.onload = function() {
            console.log('Page loaded on:', navigator.platform);
            console.log('User agent:', navigator.userAgent);
            
            initializeAudio();
            testKeyboard();
        };
    </script>
</body>
</html>
