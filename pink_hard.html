<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Game</title>
    
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-image: url('background.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            font-family: Arial, sans-serif;
            margin: 0;
        }

        header {
            padding: 10px;
            margin-top: 150px;
            text-align: center;
            color: #FF66d8;
        }

        header img {
            width: 200px;
            height: auto;
        }

        .judgment-display {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #ffffff62;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: -0;
            display: block;
        }

        .judgment-effect {
            position: absolute;
            font-size: 3em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        .judgment-effect.perfect {
            color: #ff85c2;
        }

        .judgment-effect.good {
            color: #00ffaa;
        }

        .judgment-effect.miss {
            color: #ff4444;
        }

        .judgment-effect.fade-out {
            opacity: 0;
        }
        
        #game-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-direction: row;
            width: 100%;
            height: 875px;
            background-color: #0f1018;
            position: relative;
            perspective: 1000px;
            background-image: url('pinkb1.jpg');
            background-size: 100% auto;
            background-position: center;
        }

        .lane {
            display: flex;
            justify-content: center;
            width: 180px;
            height: 800px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.85);
            margin: 0;
            transition: background-color 0.3s ease;
            overflow: hidden;
        }

        .key-label {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffffff50;
            font-size: 48px;
            font-weight: bold;
            z-index: 2;
            pointer-events: none;
        }

        footer {
            color: white;
            text-align: center;
            margin-top: 100px;
        }

        .note {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 10px !important;
            background-color: #85ffda;
            opacity: 0.9;
            z-index: 2;
            box-shadow: 0 0 10px rgba(133, 255, 218, 0.5);
        }

        .long-note {
            background-color: #ff85c2;
            height: 100px !important;
        }

        .long-note::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background-color: #ff85c2;
            box-shadow: 0 0 10px rgba(255, 133, 194, 0.5);
        }

        .long-note::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background-color: #ff85c2;
            border-radius: 0 0 2px 2px;
            box-shadow: 0 0 10px rgba(255, 133, 194, 0.5);
        }

        .note.holding {
            background-color: #ff3399;
            opacity: 0.8;
            box-shadow: 0 0 15px rgba(255, 51, 153, 0.7);
        }

        #score {
            position: absolute;
            margin-left: 600px;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 100px;
            font-weight: bold;
            z-index: 1000;
            background: linear-gradient(to top, rgb(255, 131, 224), rgb(255, 255, 255)80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes hitEffect {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        .hit-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
        }

        .hit-effect.perfect {
            border: 3px solid #ffa7d3;
            box-shadow: 0 0 10px #ffa7d3;
            animation: hitEffect 0.4s ease-out forwards;
        }

        .hit-effect.good {
            border: 3px solid #a5ffe8;
            box-shadow: 0 0 10px #a5ffe8;
            animation: hitEffect 0.4s ease-out forwards;
        }

        .judgment-line {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #caffea;
            box-shadow: 0 0 5px #bff8e0;
        }

        .hit {
            background-color: #bff8e0 !important;
            animation: hitEffect 1s ease-out, glow 0.6s ease-out;
        }

        .result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .result-content {
            background-color: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            width: 400px;
            box-shadow: 0 0 10px rgba(255, 102, 216, 0.5);
            border: 2px solid #ff66d8;
        }

        .result-content h1 {
            color: #ff66d8;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .result-stats {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            border: 2px solid #ff66d8;
            padding: 10px;
            border-radius: 8px;
        }

        .stat-label {
            color: #ff66d8;
        }

        .stat-value {
            color: white;
            font-weight: bold;
        }

        .result-breakdown {
            display: flex;
            justify-content: space-between;
            background-color: rgba(255, 102, 216, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .breakdown-item {
            display: flex;
            flex-direction: column;
        }

        .breakdown-label {
            color: #ff66d8;
            font-size: 0.9em;
        }

        .breakdown-count {
            color: white;
            font-weight: bold;
        }

        .result-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn {
            background-color: #ff66d8;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #ff99e6;
        }
    </style>
</head>
<body>
    <header>
        <img src="logo.png" alt="Rhythm Rush Logo">
    </header>

    <div class="judgment-display" id="judgment"></div>
    <div class="combo-display" id="combo">0</div>
    <audio id="game-audio" src="pink1.mp3" preload="auto"></audio>
    
    <div id="game-container">
        <div class="lane" id="lane-d">
            <div class="key-label">D</div>
            <div class="judgment-line"></div>
        </div>
        <div class="lane" id="lane-f">
            <div class="key-label">F</div>
            <div class="judgment-line"></div>
        </div>
        <div class="lane" id="lane-j">
            <div class="key-label">J</div>
            <div class="judgment-line"></div>
        </div>
        <div class="lane" id="lane-k">
            <div class="key-label">K</div>
            <div class="judgment-line"></div>
        </div>
        <div id="score">0</div>
    </div>

    <footer id="contact">
        <p>© 2025 디콘디 임예지</p>
    </footer>

    <script>
        // 난이도별 패턴 정의 - Normal 난이도로 기본 설정
        const patterns = {
            normal: [
                { time: 800, lane: 'd', speed: 1.5 },
                { time: 3500, lane: 'd', speed: 1.5 },
                { time: 4000, lane: 'f', speed: 1.5 },
                { time: 4500, lane: 'j', speed: 1.5 },
                { time: 5000, lane: 'f', speed: 1.5 },
                { time: 6500, lane: 'd', speed: 1.5 },
                { time: 7500, lane: 'd', speed: 1.5 },
                { time: 10500, lane: 'f', speed: 1.5 },
                { time: 12500, lane: 'f', speed: 1.5 },
                { time: 15500, lane: 'd', speed: 1.5 },
                { time: 17500, lane: 'd', speed: 1.5 },
                { time: 19500, lane: 'k', speed: 1.5 },
                { time: 20500, lane: 'k', speed: 1.5 },
                { time: 21000, lane: 'k', speed: 1.5 },
                { time: 21500, lane: 'j', speed: 1.5 },
                { time: 22000, lane: 'd', speed: 1.5 },
                { time: 22900, lane: 'd', speed: 1.5 },
                { time: 24200, lane: 'd', speed: 1.5 },
                { time: 24300, lane: 'f', speed: 1.5 },
                { time: 24600, lane: 'j', speed: 1.5 },
                { time: 25000, lane: 'k', speed: 1.5 },
                { time: 25500, lane: 'd', speed: 1.5 },
                { time: 26000, lane: 'f', speed: 1.5 },
                { time: 26500, lane: 'j', speed: 1.5 },
                { time: 27000, lane: 'k', speed: 1.5 },
                { time: 28000, lane: 'd', speed: 1.5 },
                { time: 28500, lane: 'f', speed: 1.5 },
                { time: 29000, lane: 'j', speed: 1.5 },
                { time: 30000, lane: 'k', speed: 1.5 },
                { time: 31000, lane: 'd', speed: 1.5 },
                { time: 34000, lane: 'f', speed: 1.5 },
                { time: 34500, lane: 'f', speed: 1.5 },
                { time: 35100, lane: 'f', speed: 1.5 },
                { time: 39000, lane: 'f', speed: 1.5 },
                { time: 41000, lane: 'f', speed: 1.5 },
                { time: 41500, lane: 'f', speed: 1.5 },
                { time: 43000, lane: 'd', speed: 1.5 },
                { time: 44000, lane: 'd', speed: 1.5 },
                { time: 48000, lane: 'd', speed: 1.5 },
                { time: 48500, lane: 'f', speed: 1.5 },
                { time: 49000, lane: 'j', speed: 1.5 },
                { time: 49500, lane: 'k', speed: 1.5 },
                { time: 50000, lane: 'k', speed: 1.5 },
                { time: 50100, lane: 'j', speed: 1.5 },
                { time: 52000, lane: 'd', speed: 1.5 },
                { time: 52800, lane: 'k', speed: 1.5 },
                { time: 54800, lane: 'k', speed: 1.5 },
                { time: 55300, lane: 'k', speed: 1.5 },
                { time: 56000, lane: 'd', speed: 1.5 },
                { time: 56800, lane: 'f', speed: 1.5 },
                { time: 57600, lane: 'd', speed: 1.5 },
                { time: 58400, lane: 'f', speed: 1.5 },
                { time: 59000, lane: 'f', speed: 1.5 },
                { time: 60000, lane: 'j', speed: 1.5 },
                { time: 61000, lane: 'k', speed: 1.5 },
                { time: 63000, lane: 'j', speed: 1.5 },
                { time: 65000, lane: 'k', speed: 1.5 },
                { time: 67000, lane: 'd', speed: 1.5 },
                { time: 68000, lane: 'f', speed: 1.5 },
                { time: 69000, lane: 'd', speed: 1.5 },
                { time: 70000, lane: 'f', speed: 1.5 },
                { time: 72000, lane: 'd', speed: 1.5 },
                { time: 72500, lane: 'f', speed: 1.5 },
                { time: 75000, lane: 'j', speed: 1.5 },
                { time: 75500, lane: 'k', speed: 1.5 },
                { time: 76000, lane: 'd', speed: 1.5 },
                { time: 77000, lane: 'f', speed: 1.5},
                { time: 77800, lane: 'f', speed: 1.5 },
                { time: 78500, lane: 'j', speed: 1.5 },
                { time: 79000, lane: 'k', speed: 1.5 },
                { time: 80000, lane: 'k', speed: 1.5 }
            ]
        };

        // 게임 요소 초기화
        const gameAudio = document.getElementById('game-audio');
        const scoreDisplay = document.getElementById('score');
        const judgmentDisplay = document.getElementById('judgment');
        const comboDisplay = document.getElementById('combo');
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let judgmentCounts = {
            'Perfect': 0,
            'Good': 0,
            'Miss': 0
        };

        let activeNotes = new Map();
        let pressedKeys = new Set();

        // 키 매핑
        const keyMap = {
            'd': 'lane-d',
            'f': 'lane-f',
            'j': 'lane-j',
            'k': 'lane-k'
        };

        const lanes = {};
        Object.keys(keyMap).forEach(key => {
            lanes[key] = document.getElementById(keyMap[key]);
        });

        // 판정 이펙트 생성 함수
        function createJudgmentEffect(judgment) {
            const existingEffects = document.querySelectorAll('.judgment-effect');
            existingEffects.forEach(effect => effect.remove());

            const judgmentEffect = document.createElement('div');
            judgmentEffect.classList.add('judgment-effect', judgment.toLowerCase());
            judgmentEffect.textContent = judgment;

            const gameContainer = document.getElementById('game-container');
            gameContainer.appendChild(judgmentEffect);

            setTimeout(() => {
                judgmentEffect.classList.add('fade-out');
            }, 300);

            setTimeout(() => {
                judgmentEffect.remove();
            }, 600);
        }

        // 노트 생성 함수
        function createNote(laneKey, noteData) {
            const lane = lanes[laneKey];
            if (!lane) return;

            const note = document.createElement('div');
            note.classList.add('note');

            if (noteData.type === 'long') {
                note.classList.add('long-note');
                note.style.height = `${noteData.duration / 10}px`;
            } else if (noteData.type === 'multi') {
                note.classList.add('multi-note');
            }

            note.style.top = '0px';
            lane.appendChild(note);

            let currentPosition = 0;
            const maxDistance = 775;
            const speed = noteData.speed || 1;

            const fallInterval = setInterval(() => {
                if (currentPosition >= maxDistance) {
                    clearInterval(fallInterval);
                    if (note.parentNode) {
                        note.parentNode.removeChild(note);
                        updateJudgment('Miss', lane);
                    }
                    return;
                }
                currentPosition += 5 * speed;
                note.style.top = `${currentPosition}px`;
            }, 20);

            return note;
        }

        // 판정 함수
        function getJudgment(notePosition) {
            const judgmentLinePosition = 735;
            const diff = Math.abs(notePosition - judgmentLinePosition);

            if (diff <= 40) return 'Perfect';
            if (diff <= 80) return 'Good';
            return 'Miss';
        }

        // 히트 이펙트 생성 함수
        function createHitEffect(lane, judgment) {
            const judgmentLine = lane.querySelector('.judgment-line');
            const rect = judgmentLine.getBoundingClientRect();
            
            const effect = document.createElement('div');
            effect.className = `hit-effect ${judgment.toLowerCase()}`;
            
            effect.style.left = `${rect.left + rect.width / 2}px`;
            effect.style.top = `${rect.top}px`;
            
            document.body.appendChild(effect);
            
            effect.addEventListener('animationend', () => {
                effect.remove();
            });
        }

        // 판정 업데이트 함수
        function updateJudgment(judgment, lane) {
            judgmentDisplay.textContent = judgment;
            judgmentDisplay.className = 'judgment-display ' + judgment.toLowerCase();
            
            judgmentCounts[judgment]++;

            if (judgment === 'Perfect' || judgment === 'Good') {
                createHitEffect(lane, judgment);
            }

            if (judgment === 'Perfect') {
                score += 100 * (combo + 1);
                combo++;
            } else if (judgment === 'Good') {
                score += 50 * (combo + 1);
                combo++;
            } else if (judgment === 'Miss') {
                combo = 0;
            }

            maxCombo = Math.max(maxCombo, combo);

            scoreDisplay.textContent = score;
            comboDisplay.textContent = `${combo}`;

            setTimeout(() => {
                judgmentDisplay.textContent = '';
            }, 500);
        }

        // 키 입력 처리
        function handleKeyDown(e) {
            const key = e.key.toLowerCase();
            if (!keyMap[key] || pressedKeys.has(key)) return;

            pressedKeys.add(key);
            const lane = lanes[key];
            if (!lane) return;
            
            changeLaneColor(lane, true);
            
            const notes = lane.getElementsByClassName('note');
            if (notes.length === 0) return;

            const firstNote = notes[0];
            const notePosition = parseInt(firstNote.style.top || '0');
            const judgment = getJudgment(notePosition);

            if (judgment === 'Miss') return;

            firstNote.remove();
            updateJudgment(judgment, lane);
        }

        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            if (!keyMap[key]) return;

            pressedKeys.delete(key);
            const lane = lanes[key];
            if (lane) {
                changeLaneColor(lane, false);
            }
        }

        // 레인 색상 변경
        function changeLaneColor(lane, isKeyDown) {
            lane.style.backgroundColor = isKeyDown ? 'rgba(255, 102, 216, 0.3)' : '#000000d5';
        }

        // 결과창 생성 함수
        function showResultScreen() {
            const resultScreen = document.createElement('div');
            resultScreen.id = 'result-screen';
            resultScreen.classList.add('result-screen');

            const totalNotes = judgmentCounts.Perfect + judgmentCounts.Good + judgmentCounts.Miss;
            const accuracy = totalNotes > 0 
                ? ((judgmentCounts.Perfect + judgmentCounts.Good * 0.5) / totalNotes * 100).toFixed(2) 
                : 0;

            resultScreen.innerHTML = `
                <div class="result-content">
                    <h1>Game Results</h1>
                    <div class="result-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Score</span>
                            <span class="stat-value">${score}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Max Combo</span>
                            <span class="stat-value">${maxCombo}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Accuracy</span>
                            <span class="stat-value">${accuracy}%</span>
                        </div>
                        <div class="result-breakdown">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Perfect</span>
                                <span class="breakdown-count">${judgmentCounts.Perfect}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Good</span>
                                <span class="breakdown-count">${judgmentCounts.Good}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Miss</span>
                                <span class="breakdown-count">${judgmentCounts.Miss}</span>
                            </div>
                        </div>
                    </div>
                    <div class="result-actions">
                        <button id="restart-btn" class="btn">Restart</button>
                    </div>
                </div>
            `;

            document.body.appendChild(resultScreen);

            document.getElementById('restart-btn').addEventListener('click', restartGame);
        }

        // 게임 재시작 함수
        function restartGame() {
            const resultScreen = document.getElementById('result-screen');
            if (resultScreen) resultScreen.remove();

            // 게임 컨테이너 숨기고 시작 화면 표시
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('header').style.display = 'none';
            document.getElementById('combo').style.display = 'none';

            // 상태 초기화
            score = 0;
            combo = 0;
            maxCombo = 0;
            judgmentCounts = {
                'Perfect': 0,
                'Good': 0,
                'Miss': 0
            };

            // 표시 업데이트
            scoreDisplay.textContent = '0';
            comboDisplay.textContent = '0';

            // 기존 노트 제거
            Object.values(lanes).forEach(lane => {
                const notes = lane.getElementsByClassName('note');
                while (notes.length > 0) {
                    notes[0].remove();
                }
            });
        }

        // 오디오 종료 시 게임 종료를 처리하는 함수
        function setupGameEndHandler() {
            gameAudio.addEventListener('ended', function() {
                showResultScreen();
            });
        }

        // 게임 시작 함수
        function startGame() {
            // 시작 화면 숨기고 게임 화면 표시
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            document.getElementById('header').style.display = 'block';
            document.getElementById('combo').style.display = 'block';

            const currentPattern = patterns.normal; // Normal 난이도로 고정

            // 점수, 콤보, 판정 통계 초기화
            score = 0;
            combo = 0;
            maxCombo = 0;
            judgmentCounts = {
                'Perfect': 0,
                'Good': 0,
                'Miss': 0
            };

            // 점수와 콤보 표시 업데이트
            scoreDisplay.textContent = '0';
            comboDisplay.textContent = '0';

            // 오디오 재생 준비
            gameAudio.currentTime = 0;
            gameAudio.play();

            // 오디오 종료 핸들러 설정
            setupGameEndHandler();

            // 노트 생성
            currentPattern.forEach(noteData => {
                setTimeout(() => {
                    if (Array.isArray(noteData.lane)) {
                        noteData.lane.forEach(lane => {
                            createNote(lane, { ...noteData, type: 'multi' });
                        });
                    } else {
                        createNote(noteData.lane, noteData);
                    }
                }, noteData.time);
            });
        }

        // 이벤트 리스너 등록
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);

        // 시작 버튼 클릭 이벤트
        document.getElementById('start-button').addEventListener('click', function() {
            startGame();
        });

        // 페이지 로드 시 시작 화면 표시
        window.onload = function() {
            // 시작 화면이 기본으로 표시됨
        };
    </script>
</body>
</html>
